name: Empty Directory Check

on:
  pull_request:
  push:
    branches: [main, master]

jobs:
  empty-dir-check:
    name: Check for Empty/Only-init Directories
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for dead directories
        run: |
          EXIT_CODE=0
          SRC_DIR="src"

          while IFS= read -r dir; do
            file_count=$(find "$dir" -maxdepth 1 -type f | wc -l)
            subdir_count=$(find "$dir" -maxdepth 1 -mindepth 1 -type d -not -name "__pycache__" | wc -l)

            if [ "$file_count" -eq 0 ] && [ "$subdir_count" -eq 0 ]; then
              echo "::error::Empty directory: $dir"
              EXIT_CODE=1
            elif [ "$file_count" -eq 1 ] && [ "$subdir_count" -eq 0 ]; then
              if [ -f "$dir/__init__.py" ]; then
                echo "::error::Directory with only __init__.py: $dir"
                EXIT_CODE=1
              fi
            fi
          done < <(find "$SRC_DIR" -type d -not -name "__pycache__" -not -path "*/__pycache__/*" 2>/dev/null)

          if [ "$EXIT_CODE" -ne 0 ]; then
            echo ""
            echo "Remove empty directories or add meaningful content to them."
          else
            echo "No dead directories found."
          fi

          exit $EXIT_CODE
